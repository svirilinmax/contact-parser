# Contact Parser

[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![Coverage](https://img.shields.io/badge/coverage-86%25-yellow.svg)](https://coverage.readthedocs.io/)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)

## Production-Ready Website Contact Information Extractor

Contact Parser — профессиональный инструмент для автоматизированного сбора контактных данных с веб-сайтов. Система выполняет обход заданного домена, извлекает email-адреса и телефонные номера, валидирует их по международным стандартам с учётом контекста и возвращает структурированный результат.

---

## Оглавление

- [Ключевые характеристики](#ключевые-характеристики)
- [Функциональные возможности](#функциональные-возможности)
- [Установка](#установка)
- [Быстрый старт](#быстрый-старт)
- [Формат результата](#формат-результата)
- [Архитектура](#архитектура)
- [Детали валидации](#детали-валидации)
- [Параметры конфигурации](#параметры-конфигурации)
- [Ограничения системы](#ограничения-системы)
- [Разработка и тестирование](#разработка-и-тестирование)
- [Примеры использования в коде](#примеры-использования-в-коде)
- [Поддерживаемые домены и коды стран](#поддерживаемые-домены-и-коды-стран)
- [Устранение неполадок](#устранение-неполадок)
- [Лицензия и авторство](#лицензия-и-авторство)

---

## Ключевые характеристики

| Параметр | Значение |
|---------|---------|
| **Тестовое покрытие** | 86% (целевой показатель: 90%+) |
| **Язык реализации** | Python 3.8+ |
| **Архитектура** | Модульная, многопоточная |
| **Формат вывода** | JSON |
| **Лицензия** | MIT |

---

## Функциональные возможности

### Извлечение контактной информации
- Email-адреса из текста страницы, mailto-ссылок, data-атрибутов
- Телефонные номера из текста, tel-ссылок, data-атрибутов, meta-тегов
- Поддержка множественных форматов записи

### Валидация данных
- **Email**: проверка формата, длины, исключение тестовых доменов, поддержка специальных символов (+, _, %)
- **Телефоны**: международный формат E.164, контекстная валидация по домену (.ru → +7, .by → +375), проверка кодов стран, фильтрация последовательностей и артикулов

### Обход сайта
- Автоматическое преобразование относительных ссылок в абсолютные
- Контроль глубины обхода (max_pages)
- Многопоточная обработка (max_workers)
- Кэширование запросов
- Защита от бесконечного обхода

### Конфигурация
- Аргументы командной строки
- Переменные окружения (префикс CONTACT_PARSER_)
- Файлы конфигурации (.py)
- Настройки по умолчанию

---

## Установка

### Из исходного кода
```bash
    git clone https://github.com/svirilinmax/contact-parser.git
    cd contact-parser
    pip install -e .
```

### Для разработки
```bash
    pip install -e ".[dev]"
    pre-commit install
```

---

## Быстрый старт

### Базовый запуск
```bash
    contact-parser https://example.com
```

### Сохранение результата
```bash
    contact-parser https://example.com --output result.json
```

### Расширенная конфигурация
```bash
    contact-parser https://example.com \
      --max-pages 100 \
      --timeout 30 \
      --workers 10 \
      --delay 0.5 \
      --output contacts.json \
      --verbose
```

### Пакетная обработка
```bash
    contact-parser --batch urls.txt --output-dir ./results
```

---

## Формат результата

```json
{
  "url": "https://example.com",
  "emails": ["info@example.com", "support@example.com"],
  "phones": ["+74951234567", "+375291234567"]
}
```

При пакетной обработке дополнительно формируется `summary.json` со сводной статистикой.

---

## Архитектура

```
    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
    │    CLI      │────▶│   Parser    │────▶│   Crawler   │
    └─────────────┘     └─────────────┘     └──────┬──────┘
                                                    │
                                                    ▼
    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
    │  Validators │◀────│  Extractors │◀────│    HTML     │
    │  (PHONE/    │     │             │     │   Parser    │
    │   EMAIL)    │     │             │     │             │
    └─────────────┘     └─────────────┘     └─────────────┘
```

```
src/contact_parser/
├── __init__.py          # Инициализация модуля
├── __main__.py         # Точка входа python -m
├── cli.py             # Парсинг аргументов, точка входа
├── config.py          # Загрузка конфигурации, логирование
├── constants.py       # Константы (коды стран, паттерны, домены)
├── crawler.py         # Многопоточный обход сайта
├── exceptions.py      # Иерархия исключений
├── extractors.py      # Извлечение email, телефонов, ссылок
├── models.py          # Pydantic-модели данных и настроек
├── output.py          # Сохранение результатов в JSON
├── parser.py          # Оркестрация процесса парсинга
├── utils.py           # URL-нормализация, HTML-парсинг, паттерны
└── validators.py      # Валидация и нормализация контактов
```

---

## Детали валидации

### Email-адреса
- Минимальная проверка: наличие @, точки в домене
- Длина: local part ≤ 64, domain ≤ 255
- Разрешённые символы: a-z, 0-9, ., _, %, +, -
- Исключаемые домены: example.*, test.*, localhost и др.
- Нормализация: lowercase, trim

### Телефонные номера
- Очистка от нецифровых символов, сохранение ведущего +
- Длина: 7-15 цифр (E.164)
- Валидация кода страны по справочнику ITU-T (70+ кодов)
- Контекстная нормализация по домену (.ru → +7, .by → +375, .com → +1)
- Фильтрация:
  - Последовательности (123456, 987654)
  - Повторяющиеся паттерны (111111, 12121212)
  - Артикулы товаров (494xxxxxxx, 172xxxxxxx)
  - Слишком много нулей (>60%)
  - Меньше 3 уникальных цифр
  - Невалидные коды операторов для РФ (после +7 не 0,1,2)

---

## Параметры конфигурации

| Параметр | CLI | ENV | Default | Описание |
|----------|-----|-----|---------|----------|
| max_pages | `--max-pages` | CONTACT_PARSER_MAX_PAGES | 50 | Максимум страниц для обхода |
| timeout | `--timeout` | CONTACT_PARSER_TIMEOUT | 15.0 | Таймаут запроса (сек) |
| request_delay | `--delay` | CONTACT_PARSER_REQUEST_DELAY | 0.2 | Задержка между запросами |
| max_workers | `--workers` | CONTACT_PARSER_MAX_WORKERS | 5 | Количество потоков |
| verify_ssl | `--no-verify-ssl` | CONTACT_PARSER_VERIFY_SSL | true | Проверка SSL |
| enable_phone_validation | `--simple-validation` | - | true | Валидация телефонов |
| enable_email_validation | `--simple-validation` | - | true | Валидация email |

---

## Ограничения системы

- **Домен**: только один домен за запуск (поддомены включаются)
- **JavaScript**: контент, генерируемый JS, не обрабатывается
- **Размер страницы**: не более 10MB
- **Глубина обхода**: настраивается, максимум 1000
- **Сетевые ошибки**: таймауты, редиректы, неподдерживаемые content-type обрабатываются с логированием

---

## Разработка и тестирование

### Запуск тестов с покрытием
```bash
    # Запуск всех тестов с отчётом о покрытии
    pytest --cov=src/contact_parser --cov-report=term-missing

    # Генерация HTML-отчёта
    pytest --cov=src/contact_parser --cov-report=html

    # Только конкретный модуль
    pytest src/tests/test_validators_country.py -v

    # Быстрая проверка
    pytest --cov=src/contact_parser --cov-fail-under=80
```

### Текущий статус покрытия
- Общее покрытие: **86%**
- Целевой уровень: **90%+**
- Критичные модули: extractors.py (85%), validators.py (83%), crawler.py (81%)

### Проверка качества кода
```bash
    black src/ tests/
    isort src/ tests/
    flake8 src/ tests/
```

### Pre-commit хуки
Проект использует pre-commit для автоматической проверки:
- trailing-whitespace, end-of-file-fixer
- black (line-length=119)
- isort (profile=black)
- flake8 (max-line-length=119)

---

## Примеры использования в коде

```python
from contact_parser import ContactParser
from contact_parser.models import ParserSettings

# Базовая настройка
settings = ParserSettings(max_pages=20, timeout=10.0)
parser = ContactParser(settings)

# Парсинг сайта
result = parser.parse_website("https://example.com")

print(f"Найдено email: {len(result.emails)}")
print(f"Найдено телефонов: {len(result.phones)}")
```

```python
# Прямое использование валидаторов
from contact_parser.validators import EmailValidator, PhoneValidator

# Валидация email с подчёркиванием
EmailValidator.is_valid_email("user_name@domain.com")  # True

# Контекстная валидация телефона
PhoneValidator.is_likely_phone("+79991234567", "https://example.ru")  # True
PhoneValidator.normalize_phone("8(999)1234567", "https://example.ru")  # +79991234567
```

---

## Поддерживаемые домены и коды стран

Автоматическое определение страны по TLD:

| TLD | Код | Страна |
|-----|-----|--------|
| .ru, .kz | 7 | Россия, Казахстан |
| .by | 375 | Беларусь |
| .ua | 380 | Украина |
| .com, .org, .net | 1 | США/Канада |
| .uk | 44 | Великобритания |
| .de | 49 | Германия |
| .fr | 33 | Франция |
| .it | 39 | Италия |
| .es | 34 | Испания |
| .pl | 48 | Польша |
| .cz | 420 | Чехия |
| .cn | 86 | Китай |
| .jp | 81 | Япония |
| .in | 91 | Индия |

Полный перечень кодов стран соответствует стандарту ITU-T E.164.

---

## Устранение неполадок

**Проблема**: Не извлекаются email с подчёркиванием
**Решение**: Обновить валидатор — символ `_` разрешён в локальной части (актуально с v2.0.0)

**Проблема**: Американские номера не проходят валидацию
**Решение**: Проверить домен (.com → код 1) и формат (10 или 11 цифр)

**Проблема**: Слишком много ложных срабатываний
**Решение**: Включена строгая валидация по умолчанию. Для отключения используйте `--simple-validation`

**Проблема**: Парсер пропускает валидные номера
**Решение**: Увеличьте `--max-pages`, проверьте наличие контента в JS

**Проблема**: Ошибки SSL-сертификатов
**Решение**: Используйте `--no-verify-ssl` для проблемных сайтов

---

## Лицензия и авторство

**Лицензия**: MIT
**Разработчик**: Максим Свирилин
**Репозиторий**: [github.com/svirilinmax/contact-parser](https://github.com/svirilinmax/contact-parser)
**Вопросы**: mak.svirilin@gmail.com
**Telegram**: @svirilinmax

---

*Contact Parser — инструмент для автоматизации сбора контактных данных, разработанный с приоритетом на надёжность, точность валидации и простоту интеграции.*
